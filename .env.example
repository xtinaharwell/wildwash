# M-Pesa Configuration Template

Copy this to your `.env` file and fill in with your actual credentials.

## Django Backend Configuration

```bash
# ============================================
# M-Pesa / Daraja API Configuration
# ============================================

# Get these from: https://daraja.safaricom.co.ke/
# 1. Log in to Daraja portal
# 2. Create an app
# 3. Generate Consumer Key and Consumer Secret
MPESA_CONSUMER_KEY=your_consumer_key_here
MPESA_CONSUMER_SECRET=your_consumer_secret_here

# Your business shortcode
# For sandbox: 174379
# For production: Your actual shortcode (check with your M-Pesa provider)
MPESA_BUSINESS_SHORTCODE=174379

# M-Pesa passkey
# For sandbox: bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c919
# For production: Your actual passkey (from M-Pesa portal)
MPESA_PASSKEY=bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c919

# Callback URL where Daraja sends payment updates
# Make sure this URL is publicly accessible and HTTPS
# Format: https://yourdomain.com/api/payments/mpesa/callback/
MPESA_CALLBACK_URL=https://api.wildwash.co.ke/api/payments/mpesa/callback/
```

## Next.js Frontend Configuration

```bash
# ============================================
# Next.js Public Configuration
# ============================================

# Backend API URL
# For development: http://localhost:8000
# For production: https://api.wildwash.co.ke
NEXT_PUBLIC_API_URL=https://api.wildwash.co.ke
```

## Environment-Specific Configurations

### Development (.env.local)

```bash
# Development settings
MPESA_CONSUMER_KEY=your_sandbox_key
MPESA_CONSUMER_SECRET=your_sandbox_secret
MPESA_BUSINESS_SHORTCODE=174379
MPESA_PASSKEY=bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c919
MPESA_CALLBACK_URL=https://your-dev-domain.com/api/payments/mpesa/callback/
NEXT_PUBLIC_API_URL=http://localhost:8000
```

### Staging (.env.staging)

```bash
# Staging settings (use production credentials for testing)
MPESA_CONSUMER_KEY=your_production_key
MPESA_CONSUMER_SECRET=your_production_secret
MPESA_BUSINESS_SHORTCODE=your_production_shortcode
MPESA_PASSKEY=your_production_passkey
MPESA_CALLBACK_URL=https://staging-api.wildwash.co.ke/api/payments/mpesa/callback/
NEXT_PUBLIC_API_URL=https://staging-api.wildwash.co.ke
```

### Production (.env.production)

```bash
# Production settings (REAL M-Pesa)
MPESA_CONSUMER_KEY=your_production_key
MPESA_CONSUMER_SECRET=your_production_secret
MPESA_BUSINESS_SHORTCODE=your_production_shortcode
MPESA_PASSKEY=your_production_passkey
MPESA_CALLBACK_URL=https://api.wildwash.co.ke/api/payments/mpesa/callback/
NEXT_PUBLIC_API_URL=https://api.wildwash.co.ke
```

## Getting Your Credentials

### Step 1: Register for Daraja API
1. Visit: https://daraja.safaricom.co.ke/
2. Click "Create an App"
3. Sign up or log in with your Safaricom account
4. Agree to terms and conditions

### Step 2: Create Your First App

1. Go to "My Apps" section
2. Click "Create App"
3. Fill in app name (e.g., "Wildwash M-Pesa")
4. Select "M-Pesa Sandbox" or "M-Pesa Live"
5. Accept terms
6. Click "Create"

### Step 3: Get Your Credentials

In the app details, you'll find:
- **Consumer Key**: Copy this
- **Consumer Secret**: Copy this

### Step 4: Get Your Shortcode

For **Sandbox**:
- Shortcode: `174379` (always use this for testing)
- Passkey: `bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c919` (always this)

For **Production**:
- Contact Safaricom to get your business shortcode
- Get your passkey from M-Pesa portal

### Step 5: Configure Callback URL

1. In Daraja portal, go to your app settings
2. Set "Callback/OAuth Redirect URL" to:
   ```
   https://api.wildwash.co.ke/api/payments/mpesa/callback/
   ```
3. Make sure this URL is:
   - HTTPS (not HTTP)
   - Publicly accessible
   - Correctly configured in your Django settings

## Verification Checklist

After setting up credentials, verify:

- [ ] MPESA_CONSUMER_KEY is set and not empty
- [ ] MPESA_CONSUMER_SECRET is set and not empty
- [ ] MPESA_BUSINESS_SHORTCODE is set (174379 for sandbox)
- [ ] MPESA_PASSKEY is set (correct value for environment)
- [ ] MPESA_CALLBACK_URL is HTTPS
- [ ] Callback URL matches Daraja app settings
- [ ] NEXT_PUBLIC_API_URL points to correct backend

## Testing Your Configuration

### Test 1: Check Environment Variables

```bash
# In Django shell
python manage.py shell
from django.conf import settings

# Should show your credentials
print(settings.MPESA_CONSUMER_KEY)
print(settings.MPESA_BUSINESS_SHORTCODE)
print(settings.MPESA_CALLBACK_URL)
```

### Test 2: Test API Connection

```python
# In Django shell
from payments.views import MpesaSTKPushView

view = MpesaSTKPushView()
try:
    token = view._get_access_token()
    print(f"✅ Connection successful! Token: {token[:20]}...")
except Exception as e:
    print(f"❌ Connection failed: {e}")
```

### Test 3: Test with cURL

```bash
# Get token
TOKEN=$(curl -X POST http://localhost:8000/api/users/login/ \
  -H "Content-Type: application/json" \
  -d '{"email":"user@test.com","password":"password"}' \
  | jq -r '.token')

# Test STK Push
curl -X POST http://localhost:8000/api/payments/mpesa/stk-push/ \
  -H "Authorization: Token $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "amount": "100",
    "phone": "254712345678",
    "order_id": "TEST-001"
  }'
```

Expected response:
```json
{
  "status": "success",
  "message": "STK push sent to your phone",
  "checkout_request_id": "ws_CO_...",
  "order_id": "TEST-001",
  "amount": "100"
}
```

## Troubleshooting

### Error: "Failed to get access token"

**Causes:**
- Invalid Consumer Key/Secret
- Credentials copied incorrectly
- Daraja API is down
- Network connectivity issue

**Solutions:**
1. Verify credentials in Daraja portal
2. Double-check for extra spaces
3. Check internet connection
4. Try again after a few minutes

### Error: "Invalid phone number"

**Cause:** Phone number format is incorrect

**Solutions:**
- Use: `254712345678` (with country code)
- Or: `0712345678` (with leading zero)
- Remove spaces and special characters

### Error: "STK push failed"

**Causes:**
- Network issues
- Invalid amount (must be positive)
- Daraja API error
- Callback URL not accessible

**Solutions:**
1. Check network connection
2. Ensure amount is valid
3. Check Daraja API status
4. Ensure callback URL is publicly accessible and HTTPS

### Callback Not Received

**Causes:**
- Callback URL not HTTPS
- Callback URL not publicly accessible
- Firewall blocking requests
- URL mismatch with Daraja settings

**Solutions:**
1. Use HTTPS only
2. Deploy to public server or use ngrok for testing
3. Check firewall/security groups
4. Verify URL in Daraja portal matches your Django setting

## Production Checklist

Before going live:

- [ ] Using production credentials (not sandbox)
- [ ] Callback URL is HTTPS
- [ ] Callback URL is publicly accessible
- [ ] MPESA_BUSINESS_SHORTCODE is correct
- [ ] Error logging is configured
- [ ] Database backups are set up
- [ ] Monitoring/alerts are configured
- [ ] Testing with real payments completed
- [ ] Support process documented
- [ ] Rollback plan prepared

## Support

**For Daraja API issues:**
- Visit: https://daraja.safaricom.co.ke/
- Check: https://daraja.safaricom.co.ke/docs
- Email: daraja@safaricom.co.ke

**For M-Pesa issues:**
- Call: Safaricom Customer Care
- Visit: https://www.safaricom.co.ke/

**For Wildwash implementation issues:**
- Check: `MPESA_IMPLEMENTATION.md`
- Check: `MPESA_QUICK_REFERENCE.md`
- Review code comments in `payments/views.py`

---

**Last Updated**: December 12, 2025
